<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, viewport-fit=cover"
    />
    <title>Camera Capture & QR Scan</title>
    <style>
      :root {
        font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
          sans-serif;
        line-height: 1.4;
        color: #1d1d1f;
        background: #f5f5f7;
      }

      body {
        margin: 0;
        padding: 1.5rem;
        display: flex;
        flex-direction: column;
        gap: 1.25rem;
        max-width: 720px;
        min-height: 100vh;
      }

      header {
        display: flex;
        flex-direction: column;
        gap: 0.25rem;
      }

      h1 {
        margin: 0;
        font-size: 1.6rem;
      }

      p {
        margin: 0;
        font-size: 0.95rem;
      }

      #camera-area {
        display: flex;
        flex-direction: column;
        gap: 1rem;
      }

      video,
      canvas,
      img {
        width: 100%;
        border-radius: 0.75rem;
        background: #000;
      }

      video {
        max-height: 60vh;
        object-fit: cover;
      }

      #capture-button-container {
        display: flex;
        justify-content: center;
        align-items: center;
        padding: 1rem 0;
      }

      #capture {
        width: 80px;
        height: 80px;
        border-radius: 50%;
        border: 4px solid #fff;
        background: #9e9e9e;
        cursor: pointer;
        padding: 0;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        transition: all 0.2s ease;
        position: relative;
        font-size: 0;
        text-indent: -9999px;
        overflow: hidden;
      }

      #capture:enabled {
        background: #9e9e9e;
      }

      #capture:enabled:active,
      #capture:enabled.pressed {
        background: #ff3b30;
        transform: scale(0.95);
        box-shadow: 0 2px 8px rgba(255, 59, 48, 0.4);
      }

      #capture:disabled {
        background: #9e9e9e;
        opacity: 0.5;
        cursor: not-allowed;
      }

      #controls {
        display: flex;
        flex-wrap: wrap;
        justify-content: center;
        gap: 0.75rem;
      }

      button {
        cursor: pointer;
        padding: 0.75rem 1.25rem;
        border-radius: 999px;
        border: none;
        font-size: 0.95rem;
        font-weight: 600;
        background: #0a84ff;
        color: #fff;
        box-shadow: 0 6px 16px rgba(10, 132, 255, 0.2);
        transition: transform 0.15s ease, box-shadow 0.15s ease;
      }

      button:hover,
      button:focus-visible {
        transform: translateY(-1px);
        box-shadow: 0 8px 18px rgba(10, 132, 255, 0.3);
      }

      button.secondary {
        background: #e5e5ea;
        color: #1d1d1f;
        box-shadow: 0 4px 10px rgba(60, 60, 67, 0.15);
      }

      #photo-output {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
      }

      #photo-output a {
        color: #0a84ff;
        text-decoration: none;
        font-weight: 600;
      }

      #qr-result {
        padding: 0.75rem 1rem;
        border-radius: 0.75rem;
        background: #f0f9ff;
        border: 1px solid #bae6ff;
        word-break: break-word;
        font-size: 0.95rem;
        display: none;
      }

      #qr-result.error {
        background: #fff1f0;
        border-color: #ffb3ab;
      }

      footer {
        margin-top: auto;
        font-size: 0.85rem;
        color: #6e6e73;
      }
    </style>
  </head>
  <body>
    <header>
      <h1>Simple Camera & QR Scanner</h1>
      <p>
        Use the buttons below to capture photos or scan QR codes directly from
        your device's camera.
      </p>
    </header>

    <section id="camera-area">
      <video id="preview" playsinline muted></video>

      <div id="capture-button-container">
        <button id="capture" disabled>Capture</button>
      </div>

      <div id="controls">
        <button id="start-camera">Start Camera</button>
        <button id="toggle-scan" class="secondary" disabled>Start QR Scan</button>
        <button id="stop" class="secondary" disabled>Stop Camera</button>
      </div>

      <div id="qr-result"></div>

      <div id="photo-output">
        <canvas id="photo-canvas" hidden></canvas>
        <img id="photo" alt="Captured photo preview" hidden />
        <a id="download-link" download="photo.jpg" hidden>Download photo</a>
        <button id="save-photo" class="secondary" hidden>Delete photo</button>
      </div>
    </section>

    <footer>
      Works offline after first load. Camera and QR scanning require granting
      browser permissions.
    </footer>

    <script>
      const preview = document.getElementById("preview");
      const startCameraBtn = document.getElementById("start-camera");
      const captureBtn = document.getElementById("capture");
      const scanBtn = document.getElementById("toggle-scan");
      const stopBtn = document.getElementById("stop");
      const canvas = document.getElementById("photo-canvas");
      const photo = document.getElementById("photo");
      const downloadLink = document.getElementById("download-link");
      const qrResult = document.getElementById("qr-result");
      const savePhotoBtn = document.getElementById("save-photo");

      let stream;
      let isScanning = false;
      let scanHandle;
      let barcodeDetector;

      function checkProtocol() {
        const protocol = window.location.protocol;
        const hostname = window.location.hostname;
        const href = window.location.href;
        
        // WebView treats file:///android_asset/ as secure context, so allow it
        const isWebView = /Android/i.test(navigator.userAgent) && 
                         (href.includes('android_asset') || href.includes('file:///android_asset'));
        
        if (isWebView) {
          return true; // WebView allows camera access from android_asset
        }
        
        if (protocol === "file:" || protocol === "content:") {
          showError(
            "⚠️ This page is opened from a file. Camera permissions may not work. " +
            "Please host this page on a website (HTTPS) or use a local server. " +
            "You can also try: Chrome Settings → Site Settings → Camera → Reset permissions for this site."
          );
          return false;
        }
        
        if (protocol === "http:" && hostname !== "localhost" && hostname !== "127.0.0.1" && !hostname.startsWith("192.168.") && !hostname.startsWith("10.")) {
          showError(
            "⚠️ Camera access requires HTTPS (secure connection). " +
            "Chrome/Brave block camera access on HTTP websites for security. " +
            "Please host this page on HTTPS or use localhost (http://localhost works)."
          );
          return false;
        }
        
        return true;
      }

      async function initCamera() {
        if (!checkProtocol()) {
          return;
        }
        
        // Check if we're in a secure context (required for camera access)
        if (!window.isSecureContext) {
          showError(
            "⚠️ Camera access requires a secure context (HTTPS or localhost). " +
            "This page is not in a secure context. Please use HTTPS or localhost."
          );
          return;
        }
        
        showMessage("Requesting camera permission...");
        try {
          stream = await navigator.mediaDevices.getUserMedia({
            video: {
              facingMode: { ideal: "environment" },
              width: { ideal: 1920 },
              height: { ideal: 1080 },
            },
            audio: false,
          });
          preview.srcObject = stream;
          await preview.play();

          captureBtn.disabled = false;
          stopBtn.disabled = false;
          scanBtn.disabled = false;
          startCameraBtn.disabled = true;

          showMessage("Camera is ready.");
        } catch (error) {
          console.error(error);
          if (error.name === "NotAllowedError" || error.name === "PermissionDeniedError") {
            showError(
              "Camera permission was denied. To fix: Open Chrome menu (⋮) → Settings → Site Settings → Camera → " +
              "Find this page and set to 'Ask' or 'Allow', then reload and try again."
            );
          } else if (error.name === "NotFoundError" || error.name === "DevicesNotFoundError") {
            showError(
              "No camera found. Please check that your device has a camera available."
            );
          } else if (error.name === "NotReadableError" || error.name === "TrackStartError") {
            showError(
              "Camera is already in use by another app. Please close other apps using the camera and try again."
            );
          } else {
            showError(
              "Could not access the camera. Please check browser permissions and try again."
            );
          }
        }
      }

      function stopCamera() {
        if (stream) {
          stream.getTracks().forEach((track) => track.stop());
          stream = undefined;
        }
        preview.srcObject = null;
        captureBtn.disabled = true;
        scanBtn.disabled = true;
        stopBtn.disabled = true;
        startCameraBtn.disabled = false;
        stopScanning();
      }

      async function savePhotoAutomatically(dataUrl) {
        // Check if Android interface is available (WebView)
        if (window.AndroidFileSaver) {
          try {
            const result = window.AndroidFileSaver.savePhoto(dataUrl);
            if (result.startsWith("Photo saved:")) {
              showMessage(result);
              return true;
            } else {
              showError(result);
              return false;
            }
          } catch (error) {
            console.error(error);
            showError("Failed to save photo: " + error.message);
            return false;
          }
        }
        
        // Fallback to browser File System Access API
        if (window.showSaveFilePicker) {
          try {
            const handle = await window.showSaveFilePicker({
              suggestedName: "photo.jpg",
              types: [
                {
                  description: "JPEG Image",
                  accept: { "image/jpeg": [".jpg", ".jpeg"] },
                },
              ],
            });
            const writable = await handle.createWritable();
            const response = await fetch(dataUrl);
            await writable.write(await response.blob());
            await writable.close();
            showMessage("Photo saved to device storage.");
            return true;
          } catch (error) {
            if (error.name !== "AbortError") {
              console.error(error);
              // Don't show error for user cancellation, just return false
              return false;
            }
            return false;
          }
        }
        
        // No save method available
        return false;
      }

      async function capturePhoto() {
        if (!preview.srcObject) {
          return;
        }
        const trackSettings = preview.srcObject
          .getVideoTracks()[0]
          ?.getSettings();
        const width = preview.videoWidth || trackSettings?.width || 1280;
        const height = preview.videoHeight || trackSettings?.height || 720;

        canvas.width = width;
        canvas.height = height;
        const ctx = canvas.getContext("2d");
        ctx.drawImage(preview, 0, 0, width, height);

        const dataUrl = canvas.toDataURL("image/jpeg", 0.92);
        photo.src = dataUrl;
        photo.hidden = false;

        downloadLink.href = dataUrl;
        downloadLink.hidden = false;
        savePhotoBtn.hidden = false;
        
        // Automatically save the photo
        showMessage("Saving photo...");
        const saved = await savePhotoAutomatically(dataUrl);
        if (!saved) {
          showMessage("Photo captured. You can download it below.");
        }
      }

      function showMessage(message) {
        if (!message) {
          qrResult.style.display = "none";
          qrResult.textContent = "";
          qrResult.classList.remove("error");
          return;
        }
        // Only set textContent if it's a plain string, preserve HTML if already set
        if (typeof message === "string" && !qrResult.querySelector("a") && !qrResult.querySelector("button")) {
          qrResult.textContent = message;
        }
        qrResult.classList.remove("error");
        qrResult.style.display = "block";
      }

      function showError(message) {
        qrResult.textContent = message;
        qrResult.classList.add("error");
        qrResult.style.display = "block";
      }

      function stopScanning() {
        isScanning = false;
        scanBtn.textContent = "Start QR Scan";
        if (scanHandle) {
          cancelAnimationFrame(scanHandle);
          scanHandle = undefined;
        }
      }

      function startScanning() {
        if (!preview.srcObject) {
          showError("Start the camera before scanning QR codes.");
          return;
        }
        if (!("BarcodeDetector" in window)) {
          showError(
            "Barcode Detector API is not available in this browser. Try the latest Chrome."
          );
          return;
        }

        if (!barcodeDetector) {
          try {
            barcodeDetector = new BarcodeDetector({ formats: ["qr_code"] });
          } catch (error) {
            console.error(error);
            showError("Failed to initialize the barcode detector.");
            return;
          }
        }

        isScanning = true;
        scanBtn.textContent = "Stop QR Scan";
        scanLoop();
      }

      function isURL(str) {
        try {
          const url = new URL(str);
          return url.protocol === "http:" || url.protocol === "https:";
        } catch {
          return false;
        }
      }

      function handleQRCodeResult(value) {
        stopScanning();
        
        // Clear previous content
        qrResult.innerHTML = "";
        qrResult.classList.remove("error");
        qrResult.style.display = "block";
        
        if (isURL(value)) {
          // It's a URL - offer to open it
          const messageDiv = document.createElement("div");
          messageDiv.textContent = `QR Code detected: ${value}`;
          messageDiv.style.marginBottom = "0.75rem";
          qrResult.appendChild(messageDiv);
          
          // Create a clickable link
          const link = document.createElement("a");
          link.href = value;
          link.target = "_blank";
          link.rel = "noopener noreferrer";
          link.textContent = "Open Link";
          link.style.cssText = "display: inline-block; margin-right: 0.5rem; padding: 0.75rem 1.25rem; background: #0a84ff; color: white; text-decoration: none; border-radius: 0.5rem; font-weight: 600; cursor: pointer;";
          qrResult.appendChild(link);
          
          // Also add a copy button
          const copyBtn = document.createElement("button");
          copyBtn.textContent = "Copy";
          copyBtn.style.cssText = "display: inline-block; padding: 0.75rem 1.25rem; background: #e5e5ea; color: #1d1d1f; border: none; border-radius: 0.5rem; font-weight: 600; cursor: pointer;";
          copyBtn.onclick = () => {
            navigator.clipboard.writeText(value).then(() => {
              copyBtn.textContent = "Copied!";
              setTimeout(() => copyBtn.textContent = "Copy", 2000);
            }).catch(() => {
              // Fallback for older browsers
              const textArea = document.createElement("textarea");
              textArea.value = value;
              document.body.appendChild(textArea);
              textArea.select();
              document.execCommand("copy");
              document.body.removeChild(textArea);
              copyBtn.textContent = "Copied!";
              setTimeout(() => copyBtn.textContent = "Copy", 2000);
            });
          };
          qrResult.appendChild(copyBtn);
        } else {
          // Not a URL - just show the value with copy option
          const messageDiv = document.createElement("div");
          messageDiv.textContent = `QR Code: ${value}`;
          messageDiv.style.marginBottom = "0.75rem";
          qrResult.appendChild(messageDiv);
          
          const copyBtn = document.createElement("button");
          copyBtn.textContent = "Copy";
          copyBtn.style.cssText = "display: inline-block; padding: 0.75rem 1.25rem; background: #0a84ff; color: white; border: none; border-radius: 0.5rem; font-weight: 600; cursor: pointer;";
          copyBtn.onclick = () => {
            navigator.clipboard.writeText(value).then(() => {
              copyBtn.textContent = "Copied!";
              setTimeout(() => copyBtn.textContent = "Copy", 2000);
            }).catch(() => {
              // Fallback for older browsers
              const textArea = document.createElement("textarea");
              textArea.value = value;
              document.body.appendChild(textArea);
              textArea.select();
              document.execCommand("copy");
              document.body.removeChild(textArea);
              copyBtn.textContent = "Copied!";
              setTimeout(() => copyBtn.textContent = "Copy", 2000);
            });
          };
          qrResult.appendChild(copyBtn);
        }
      }

      async function scanLoop() {
        if (!isScanning || !barcodeDetector) {
          return;
        }
        try {
          const barcodes = await barcodeDetector.detect(preview);
          if (barcodes.length) {
            const qrValue = barcodes[0].rawValue;
            handleQRCodeResult(qrValue);
            return;
          } else if (!qrResult.classList.contains("error")) {
            showMessage("Scanning for QR codes...");
          }
        } catch (error) {
          console.error(error);
          showError("QR scanning failed. Try restarting the camera.");
          stopScanning();
          return;
        }
        scanHandle = requestAnimationFrame(scanLoop);
      }

      startCameraBtn.addEventListener("click", initCamera);
      stopBtn.addEventListener("click", stopCamera);
      
      // Capture button with visual feedback
      captureBtn.addEventListener("mousedown", () => {
        if (!captureBtn.disabled) {
          captureBtn.classList.add("pressed");
        }
      });
      captureBtn.addEventListener("mouseup", () => {
        captureBtn.classList.remove("pressed");
      });
      captureBtn.addEventListener("mouseleave", () => {
        captureBtn.classList.remove("pressed");
      });
      captureBtn.addEventListener("touchstart", () => {
        if (!captureBtn.disabled) {
          captureBtn.classList.add("pressed");
        }
      });
      captureBtn.addEventListener("touchend", () => {
        captureBtn.classList.remove("pressed");
      });
      captureBtn.addEventListener("click", () => {
        captureBtn.classList.remove("pressed");
        capturePhoto();
      });
      savePhotoBtn.addEventListener("click", () => {
        if (!photo.src) {
          return;
        }
        
        // Delete the last photo from storage
        if (window.AndroidFileSaver) {
          try {
            const result = window.AndroidFileSaver.deleteLastPhoto();
            if (result.includes("successfully")) {
              // Clear UI
              photo.src = "";
              photo.hidden = true;
              canvas.hidden = true;
              downloadLink.href = "";
              downloadLink.hidden = true;
              savePhotoBtn.hidden = true;
              showMessage(result);
            } else {
              showError(result);
            }
          } catch (error) {
            console.error(error);
            showError("Failed to delete photo: " + error.message);
          }
        } else {
          // Not in WebView, just clear UI
          photo.src = "";
          photo.hidden = true;
          canvas.hidden = true;
          downloadLink.href = "";
          downloadLink.hidden = true;
          savePhotoBtn.hidden = true;
          showMessage("Photo removed from display (file deletion not available in browser).");
        }
        
        // Clear message after a short delay
        setTimeout(() => {
          showMessage("");
        }, 3000);
      });
      scanBtn.addEventListener("click", () => {
        if (isScanning) {
          showMessage("");
          stopScanning();
        } else {
          startScanning();
        }
      });

      window.addEventListener("beforeunload", stopCamera);

      // Check protocol on page load
      const protocol = window.location.protocol;
      const hostname = window.location.hostname;
      const href = window.location.href;
      const isWebView = /Android/i.test(navigator.userAgent) && 
                       (href.includes('android_asset') || href.includes('file:///android_asset'));
      
      if (!isWebView) {
        if (protocol === "file:" || protocol === "content:") {
          setTimeout(() => {
            showError(
              "⚠️ This page is opened from a file. Camera permissions may not work on Android. " +
              "For best results, host this page on a website (HTTPS) or use a local server. " +
              "Alternatively, go to Chrome Settings → Site Settings → Camera and reset permissions."
            );
          }, 500);
        } else if (protocol === "http:" && hostname !== "localhost" && hostname !== "127.0.0.1" && !hostname.startsWith("192.168.") && !hostname.startsWith("10.")) {
          setTimeout(() => {
            showError(
              "⚠️ Camera access requires HTTPS. Chrome/Brave block camera on HTTP websites. " +
              "Please use HTTPS or localhost (http://localhost works)."
            );
          }, 500);
        }
      }

      // Automatically start camera when page loads (especially in WebView/Android app)
      if (isWebView) {
        // In Android app, start camera automatically after a short delay
        setTimeout(() => {
          initCamera();
        }, 500);
      }
    </script>
  </body>
</html>

