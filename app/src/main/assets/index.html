<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, viewport-fit=cover"
    />
    <title>Camera Capture & QR Scan</title>
    <style>
      :root {
        font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
          sans-serif;
        line-height: 1.4;
        color: #1d1d1f;
        background: #f5f5f7;
      }

      body {
        margin: 0;
        padding: 1.5rem;
        display: flex;
        flex-direction: column;
        gap: 1.25rem;
        max-width: 720px;
        min-height: 100vh;
      }

      header {
        display: flex;
        flex-direction: column;
        gap: 0.25rem;
      }

      h1 {
        margin: 0;
        font-size: 1.6rem;
      }

      p {
        margin: 0;
        font-size: 0.95rem;
      }

      #camera-area {
        display: grid;
        gap: 1rem;
      }

      video,
      canvas,
      img {
        width: 100%;
        border-radius: 0.75rem;
        background: #000;
      }

      video {
        max-height: 60vh;
        object-fit: cover;
      }

      #controls {
        display: flex;
        flex-wrap: wrap;
        gap: 0.75rem;
      }

      button {
        cursor: pointer;
        padding: 0.75rem 1.25rem;
        border-radius: 999px;
        border: none;
        font-size: 0.95rem;
        font-weight: 600;
        background: #0a84ff;
        color: #fff;
        box-shadow: 0 6px 16px rgba(10, 132, 255, 0.2);
        transition: transform 0.15s ease, box-shadow 0.15s ease;
      }

      button:hover,
      button:focus-visible {
        transform: translateY(-1px);
        box-shadow: 0 8px 18px rgba(10, 132, 255, 0.3);
      }

      button.secondary {
        background: #e5e5ea;
        color: #1d1d1f;
        box-shadow: 0 4px 10px rgba(60, 60, 67, 0.15);
      }

      #photo-output {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
      }

      #photo-output a {
        color: #0a84ff;
        text-decoration: none;
        font-weight: 600;
      }

      #qr-result {
        padding: 0.75rem 1rem;
        border-radius: 0.75rem;
        background: #f0f9ff;
        border: 1px solid #bae6ff;
        word-break: break-word;
        font-size: 0.95rem;
        display: none;
      }

      #qr-result.error {
        background: #fff1f0;
        border-color: #ffb3ab;
      }

      footer {
        margin-top: auto;
        font-size: 0.85rem;
        color: #6e6e73;
      }
    </style>
  </head>
  <body>
    <header>
      <h1>Simple Camera & QR Scanner</h1>
      <p>
        Use the buttons below to capture photos or scan QR codes directly from
        your device's camera.
      </p>
    </header>

    <section id="camera-area">
      <video id="preview" playsinline muted></video>

      <div id="controls">
        <button id="start-camera">Start Camera</button>
        <button id="capture" class="secondary" disabled>Capture Photo</button>
        <button id="toggle-scan" class="secondary" disabled>Start QR Scan</button>
        <button id="stop" class="secondary" disabled>Stop Camera</button>
      </div>

      <div id="qr-result"></div>

      <div id="photo-output">
        <canvas id="photo-canvas" hidden></canvas>
        <img id="photo" alt="Captured photo preview" hidden />
        <a id="download-link" download="photo.jpg" hidden>Download photo</a>
        <button id="save-photo" class="secondary" hidden>Save photo</button>
      </div>
    </section>

    <footer>
      Works offline after first load. Camera and QR scanning require granting
      browser permissions.
    </footer>

    <script>
      const preview = document.getElementById("preview");
      const startCameraBtn = document.getElementById("start-camera");
      const captureBtn = document.getElementById("capture");
      const scanBtn = document.getElementById("toggle-scan");
      const stopBtn = document.getElementById("stop");
      const canvas = document.getElementById("photo-canvas");
      const photo = document.getElementById("photo");
      const downloadLink = document.getElementById("download-link");
      const qrResult = document.getElementById("qr-result");
      const savePhotoBtn = document.getElementById("save-photo");

      let stream;
      let isScanning = false;
      let scanHandle;
      let barcodeDetector;

      function checkProtocol() {
        const protocol = window.location.protocol;
        const hostname = window.location.hostname;
        const href = window.location.href;
        
        // WebView treats file:///android_asset/ as secure context, so allow it
        const isWebView = /Android/i.test(navigator.userAgent) && 
                         (href.includes('android_asset') || href.includes('file:///android_asset'));
        
        if (isWebView) {
          return true; // WebView allows camera access from android_asset
        }
        
        if (protocol === "file:" || protocol === "content:") {
          showError(
            "⚠️ This page is opened from a file. Camera permissions may not work. " +
            "Please host this page on a website (HTTPS) or use a local server. " +
            "You can also try: Chrome Settings → Site Settings → Camera → Reset permissions for this site."
          );
          return false;
        }
        
        if (protocol === "http:" && hostname !== "localhost" && hostname !== "127.0.0.1" && !hostname.startsWith("192.168.") && !hostname.startsWith("10.")) {
          showError(
            "⚠️ Camera access requires HTTPS (secure connection). " +
            "Chrome/Brave block camera access on HTTP websites for security. " +
            "Please host this page on HTTPS or use localhost (http://localhost works)."
          );
          return false;
        }
        
        return true;
      }

      async function initCamera() {
        if (!checkProtocol()) {
          return;
        }
        
        // Check if we're in a secure context (required for camera access)
        if (!window.isSecureContext) {
          showError(
            "⚠️ Camera access requires a secure context (HTTPS or localhost). " +
            "This page is not in a secure context. Please use HTTPS or localhost."
          );
          return;
        }
        
        showMessage("Requesting camera permission...");
        try {
          stream = await navigator.mediaDevices.getUserMedia({
            video: {
              facingMode: { ideal: "environment" },
              width: { ideal: 1920 },
              height: { ideal: 1080 },
            },
            audio: false,
          });
          preview.srcObject = stream;
          await preview.play();

          captureBtn.disabled = false;
          stopBtn.disabled = false;
          scanBtn.disabled = false;
          startCameraBtn.disabled = true;

          showMessage("Camera is ready.");
        } catch (error) {
          console.error(error);
          if (error.name === "NotAllowedError" || error.name === "PermissionDeniedError") {
            showError(
              "Camera permission was denied. To fix: Open Chrome menu (⋮) → Settings → Site Settings → Camera → " +
              "Find this page and set to 'Ask' or 'Allow', then reload and try again."
            );
          } else if (error.name === "NotFoundError" || error.name === "DevicesNotFoundError") {
            showError(
              "No camera found. Please check that your device has a camera available."
            );
          } else if (error.name === "NotReadableError" || error.name === "TrackStartError") {
            showError(
              "Camera is already in use by another app. Please close other apps using the camera and try again."
            );
          } else {
            showError(
              "Could not access the camera. Please check browser permissions and try again."
            );
          }
        }
      }

      function stopCamera() {
        if (stream) {
          stream.getTracks().forEach((track) => track.stop());
          stream = undefined;
        }
        preview.srcObject = null;
        captureBtn.disabled = true;
        scanBtn.disabled = true;
        stopBtn.disabled = true;
        startCameraBtn.disabled = false;
        stopScanning();
      }

      function capturePhoto() {
        if (!preview.srcObject) {
          return;
        }
        const trackSettings = preview.srcObject
          .getVideoTracks()[0]
          ?.getSettings();
        const width = preview.videoWidth || trackSettings?.width || 1280;
        const height = preview.videoHeight || trackSettings?.height || 720;

        canvas.width = width;
        canvas.height = height;
        const ctx = canvas.getContext("2d");
        ctx.drawImage(preview, 0, 0, width, height);

        const dataUrl = canvas.toDataURL("image/jpeg", 0.92);
        photo.src = dataUrl;
        photo.hidden = false;

        downloadLink.href = dataUrl;
        downloadLink.hidden = false;
        savePhotoBtn.hidden = false;
        showMessage("Photo captured. You can download it below.");
      }

      function showMessage(message) {
        if (!message) {
          qrResult.style.display = "none";
          qrResult.textContent = "";
          qrResult.classList.remove("error");
          return;
        }
        qrResult.textContent = message;
        qrResult.classList.remove("error");
        qrResult.style.display = "block";
      }

      function showError(message) {
        qrResult.textContent = message;
        qrResult.classList.add("error");
        qrResult.style.display = "block";
      }

      function stopScanning() {
        isScanning = false;
        scanBtn.textContent = "Start QR Scan";
        if (scanHandle) {
          cancelAnimationFrame(scanHandle);
          scanHandle = undefined;
        }
      }

      function startScanning() {
        if (!preview.srcObject) {
          showError("Start the camera before scanning QR codes.");
          return;
        }
        if (!("BarcodeDetector" in window)) {
          showError(
            "Barcode Detector API is not available in this browser. Try the latest Chrome."
          );
          return;
        }

        if (!barcodeDetector) {
          try {
            barcodeDetector = new BarcodeDetector({ formats: ["qr_code"] });
          } catch (error) {
            console.error(error);
            showError("Failed to initialize the barcode detector.");
            return;
          }
        }

        isScanning = true;
        scanBtn.textContent = "Stop QR Scan";
        scanLoop();
      }

      async function scanLoop() {
        if (!isScanning || !barcodeDetector) {
          return;
        }
        try {
          const barcodes = await barcodeDetector.detect(preview);
          if (barcodes.length) {
            stopScanning();
            showMessage(`QR Code: ${barcodes[0].rawValue}`);
            return;
          } else if (!qrResult.classList.contains("error")) {
            showMessage("Scanning for QR codes...");
          }
        } catch (error) {
          console.error(error);
          showError("QR scanning failed. Try restarting the camera.");
          stopScanning();
          return;
        }
        scanHandle = requestAnimationFrame(scanLoop);
      }

      startCameraBtn.addEventListener("click", initCamera);
      stopBtn.addEventListener("click", stopCamera);
      captureBtn.addEventListener("click", capturePhoto);
      savePhotoBtn.addEventListener("click", async () => {
        if (!photo.src) {
          return;
        }
        
        // Check if Android interface is available (WebView)
        if (window.AndroidFileSaver) {
          showMessage("Saving photo...");
          try {
            // Extract base64 data from data URL
            const base64Data = photo.src;
            const result = window.AndroidFileSaver.savePhoto(base64Data);
            if (result.startsWith("Photo saved:")) {
              showMessage(result);
            } else {
              showError(result);
            }
          } catch (error) {
            console.error(error);
            showError("Failed to save photo: " + error.message);
          }
          return;
        }
        
        // Fallback to browser File System Access API
        if (window.showSaveFilePicker) {
          showMessage("Choose a location to save the photo...");
          try {
            const handle = await window.showSaveFilePicker({
              suggestedName: "photo.jpg",
              types: [
                {
                  description: "JPEG Image",
                  accept: { "image/jpeg": [".jpg", ".jpeg"] },
                },
              ],
            });
            const writable = await handle.createWritable();
            const response = await fetch(photo.src);
            await writable.write(await response.blob());
            await writable.close();
            showMessage("Photo saved to device storage.");
            return;
          } catch (error) {
            if (error.name !== "AbortError") {
              console.error(error);
              showError("Saving failed. Try the download link instead.");
            }
          }
        }
        
        // Final fallback: download link
        downloadLink.click();
      });
      scanBtn.addEventListener("click", () => {
        if (isScanning) {
          showMessage("");
          stopScanning();
        } else {
          startScanning();
        }
      });

      window.addEventListener("beforeunload", stopCamera);

      // Check protocol on page load
      const protocol = window.location.protocol;
      const hostname = window.location.hostname;
      const href = window.location.href;
      const isWebView = /Android/i.test(navigator.userAgent) && 
                       (href.includes('android_asset') || href.includes('file:///android_asset'));
      
      if (!isWebView) {
        if (protocol === "file:" || protocol === "content:") {
          setTimeout(() => {
            showError(
              "⚠️ This page is opened from a file. Camera permissions may not work on Android. " +
              "For best results, host this page on a website (HTTPS) or use a local server. " +
              "Alternatively, go to Chrome Settings → Site Settings → Camera and reset permissions."
            );
          }, 500);
        } else if (protocol === "http:" && hostname !== "localhost" && hostname !== "127.0.0.1" && !hostname.startsWith("192.168.") && !hostname.startsWith("10.")) {
          setTimeout(() => {
            showError(
              "⚠️ Camera access requires HTTPS. Chrome/Brave block camera on HTTP websites. " +
              "Please use HTTPS or localhost (http://localhost works)."
            );
          }, 500);
        }
      }
    </script>
  </body>
</html>

